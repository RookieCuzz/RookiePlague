# MonsterController é…ç½®ç®¡ç†æ¶æ„è®¾è®¡

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡çš„é…ç½®ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒçµæ´»çš„é…ç½®åŠ è½½ã€ç¼“å­˜ç®¡ç†å’Œä¸šåŠ¡æ•°æ®è§£æã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

è¯¦ç»†ç±»å›¾å‚è§ï¼š`MonsterController/uml/é…ç½®ç®¡ç†å™¨ç±»å›¾.puml`

### åˆ†å±‚è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä¸šåŠ¡æœåŠ¡å±‚ (Service)               â”‚
â”‚  - MonsterConfService: æ€ªç‰©é…ç½®ä¸šåŠ¡é€»è¾‘          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         é…ç½®ç®¡ç†å±‚ (Config)                  â”‚
â”‚  - ConfigurationManager: é…ç½®ç¼“å­˜ä¸ç®¡ç†      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         SPI æ¥å£å±‚ (config.spi)              â”‚
â”‚  - ConfigurationLoader: é…ç½®åŠ è½½æ¥å£         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         å®ç°å±‚ (config.impl)                 â”‚
â”‚  - FileConfigurationLoader: æ–‡ä»¶åŠ è½½å®ç°     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         æ•°æ®æ¨¡å‹å±‚ (Model)                   â”‚
â”‚  - MonsterConfig: æ€ªç‰©é…ç½®æ•°æ®æ¨¡å‹           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ åŒ…ç»“æ„

```
com.cuzz.monsterController
â”œâ”€â”€ MonsterController.java          // ä¸»ç±»ï¼Œæ’ä»¶å…¥å£
â”œâ”€â”€ config/                          // é…ç½®ç®¡ç†åŒ…
â”‚   â”œâ”€â”€ ConfigurationManager.java   // é…ç½®ç®¡ç†å™¨ï¼ˆç¼“å­˜+ç»Ÿä¸€è®¿é—®ï¼‰
â”‚   â”œâ”€â”€ spi/                        // SPI æ¥å£åŒ…
â”‚   â”‚   â””â”€â”€ ConfigurationLoader.java // é…ç½®åŠ è½½å™¨æ¥å£
â”‚   â””â”€â”€ impl/                       // å®ç°åŒ…
â”‚       â””â”€â”€ FileConfigurationLoader.java // æ–‡ä»¶é…ç½®åŠ è½½å™¨å®ç°
â”œâ”€â”€ model/                          // ä¸šåŠ¡é¢†åŸŸæ¨¡å‹åŒ…
â”‚   â””â”€â”€ MonsterConfig.java         // æ€ªç‰©é…ç½®æ•°æ®æ¨¡å‹
â””â”€â”€ service/                        // ä¸šåŠ¡æœåŠ¡åŒ…
    â””â”€â”€ MonsterService.java        // æ€ªç‰©é…ç½®æœåŠ¡
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. ConfigurationLoader (SPI æ¥å£)

**èŒè´£**ï¼šå®šä¹‰é…ç½®åŠ è½½çš„æ ‡å‡†è¡Œä¸º

```java
public interface ConfigurationLoader {
    YamlConfiguration loadConfig(String name);
    YamlConfiguration reloadConfig(String name);
    boolean exists(String name);
}
```

**ç‰¹ç‚¹**ï¼š
- æ”¯æŒå¤šç§å®ç°æ–¹å¼ï¼ˆæ–‡ä»¶ã€äº‘ç«¯ã€æ•°æ®åº“ç­‰ï¼‰
- éµå¾ª SPI è®¾è®¡æ¨¡å¼
- ä¾¿äºæ‰©å±•å’Œæµ‹è¯•

### 2. FileConfigurationLoader (å®ç°ç±»)

**èŒè´£**ï¼šä»æœ¬åœ°æ–‡ä»¶ç³»ç»ŸåŠ è½½ YAML é…ç½®

**å®ç°ç‰¹ç‚¹**ï¼š
- è‡ªåŠ¨ä»æ’ä»¶èµ„æºå¤åˆ¶é»˜è®¤é…ç½®
- æ”¯æŒåˆ—è¡¨æ ¼å¼çš„ YAML æ–‡ä»¶ï¼ˆå¦‚ monsters.ymlï¼‰
- å¤„ç†é…ç½®æ–‡ä»¶ä¸å­˜åœ¨çš„æƒ…å†µ
- åŠ è½½é»˜è®¤é…ç½®ä½œä¸º fallback

**å…³é”®å®ç°**ï¼š
```java
// ä½¿ç”¨ SnakeYAML æ£€æµ‹æ•°æ®ç±»å‹
Object data = yaml.load(fis);
if (data instanceof List) {
    // åˆ—è¡¨æ ¼å¼åŒ…è£…å¤„ç†
    config.set("monsters", data);
} else {
    // æ™®é€š Map æ ¼å¼æ­£å¸¸åŠ è½½
    config = YamlConfiguration.loadConfiguration(configFile);
}
```

### 3. ConfigurationManager (ç®¡ç†å™¨)

**èŒè´£**ï¼šæä¾›ç»Ÿä¸€çš„é…ç½®è®¿é—®æ¥å£å’Œç¼“å­˜ç®¡ç†

**åŠŸèƒ½**ï¼š
- âœ… é…ç½®ç¼“å­˜ï¼ˆé¿å…é‡å¤åŠ è½½ï¼‰
- âœ… é…ç½®çƒ­é‡è½½
- âœ… ç»Ÿä¸€è®¿é—®å…¥å£
- âœ… é…ç½®å­˜åœ¨æ€§æ£€æŸ¥

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
ConfigurationManager manager = new ConfigurationManager(loader);
YamlConfiguration config = manager.getConfig("monsters.yml");
YamlConfiguration reloaded = manager.reloadConfig("monsters.yml");
```

### 4. MonsterConfig (æ•°æ®æ¨¡å‹)

**èŒè´£**ï¼šæ€ªç‰©é…ç½®çš„æ•°æ®æ¨¡å‹å’Œè§£æé€»è¾‘

**å­—æ®µ**ï¼š
- `id`: æ€ªç‰©ID
- `type`: æ€ªç‰©ç±»å‹ï¼ˆç”¨ä½œå”¯ä¸€æ ‡è¯†ï¼‰
- `desc`: æ€ªç‰©æè¿°
- `rangeChunk`: åˆ·æ–°èŒƒå›´ï¼ˆåŒºå—ï¼‰
- `restrainRate`: é™åˆ¶æ¯”ç‡
- `spawnRate`: åˆ·æ–°é¢‘ç‡
- `dropMulti`: æ‰è½å€ç‡
- `shinyMob`: é—ªå…‰æ€ªç‰©ID

**è§£ææ–¹æ³•**ï¼š

1. **åˆ—è¡¨è§£æ**ï¼š
```java
List<MonsterConfig> monsters = MonsterConfig.parseFromConfig(config);
```

2. **Map è§£æ**ï¼ˆæ¨èï¼Œé«˜æ•ˆï¼‰ï¼š
```java
Map<String, MonsterConfig> monsterMap = MonsterConfig.parseToMap(config);
MonsterConfig zombie = monsterMap.get("ZOMBIE"); // O(1) æŸ¥æ‰¾
```

**ç‰¹ç‚¹**ï¼š
- ç±»å‹å®‰å…¨è½¬æ¢ï¼ˆintã€doubleã€Stringï¼‰
- æ”¯æŒé»˜è®¤å€¼
- åŒæ¨¡å¼è§£æï¼ˆList/Mapï¼‰
- è‡ªåŠ¨å¤„ç† YAML åˆ—è¡¨æ ¼å¼

### 5. MonsterService (ä¸šåŠ¡æœåŠ¡)

**èŒè´£**ï¼šç®¡ç†æ€ªç‰©é…ç½®çš„ä¸šåŠ¡é€»è¾‘

**åŠŸèƒ½**ï¼š
- âœ… åŠ è½½æ€ªç‰©é…ç½®
- âœ… é‡è½½é…ç½®
- âœ… æ ¹æ®ç±»å‹æŸ¥è¯¢é…ç½®
- âœ… è·å–æ‰€æœ‰é…ç½®
- âœ… é…ç½®å­˜åœ¨æ€§æ£€æŸ¥
- âœ… è·å–é…ç½®æ•°é‡

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
MonsterService service = new MonsterService(configManager);
service.loadConfig();

// æŸ¥è¯¢é…ç½®
MonsterConfig config = service.getMonsterConfig("ZOMBIE");

// é‡è½½é…ç½®
service.reloadConfig();
```

## ğŸ“„ é…ç½®æ–‡ä»¶

### config.yml - å…¨å±€é…ç½®

```yaml
messages:
  onEnable: "Monster Controller has been enabled!"
  onDisable: "Monster Controller has been disabled!"
```

### monsters.yml - æ€ªç‰©é…ç½®

```yaml
- id: 1
  type: 'ZOMBIE'
  desc: 'åƒµå°¸'
  rangeChunk: 3
  restrainRate: 30
  spawnRate: 3
  dropMulti: 3
  shinyMob: 'shiny_zombie'
- id: 2
  type: 'SKELETON'
  desc: 'éª·é«…'
  rangeChunk: 3
  restrainRate: 25
  spawnRate: 3
  dropMulti: 2.5
  shinyMob: 'shiny_skeleton'
# ... æ›´å¤šæ€ªç‰©é…ç½®
```

**æ³¨æ„**ï¼š
- monsters.yml æ˜¯åˆ—è¡¨æ ¼å¼
- åŠ è½½åä¼šè‡ªåŠ¨è½¬æ¢ä¸º `Map<String, MonsterConfig>`
- ä»¥ `type` å­—æ®µä½œä¸º Map çš„ key

## ğŸ”„ æ•°æ®æµç¨‹

### é…ç½®åŠ è½½æµç¨‹

```mermaid
graph LR
    A[æ’ä»¶å¯åŠ¨] --> B[åˆ›å»º FileConfigurationLoader]
    B --> C[åˆ›å»º ConfigurationManager]
    C --> D[åˆ›å»º MonsterService]
    D --> E[åŠ è½½ monsters.yml]
    E --> F[FileConfigurationLoader è¯»å–æ–‡ä»¶]
    F --> G[æ£€æµ‹ä¸ºåˆ—è¡¨æ ¼å¼]
    G --> H[åŒ…è£…ä¸º monsters: []]
    H --> I[è¿”å› YamlConfiguration]
    I --> J[MonsterConfig.parseToMap]
    J --> K[è½¬æ¢ä¸º Map<String, MonsterConfig>]
    K --> L[ç¼“å­˜åˆ° MonsterService]
```

### é…ç½®æŸ¥è¯¢æµç¨‹

```mermaid
graph LR
    A[ä¸šåŠ¡ä»£ç ] --> B[MonsterService.getMonsterConfig]
    B --> C{ç¼“å­˜ä¸­å­˜åœ¨?}
    C -->|æ˜¯| D[ç›´æ¥è¿”å›]
    C -->|å¦| E[è¿”å› null]
```

### é…ç½®é‡è½½æµç¨‹

```mermaid
graph LR
    A[é‡è½½å‘½ä»¤] --> B[MonsterService.reloadConfig]
    B --> C[ConfigurationManager.reloadConfig]
    C --> D[FileConfigurationLoader.reloadConfig]
    D --> E[é‡æ–°è¯»å–æ–‡ä»¶]
    E --> F[æ›´æ–°ç¼“å­˜]
    F --> G[MonsterConfig.parseToMap]
    G --> H[æ›´æ–° Service ç¼“å­˜]
```

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### 1. æ¸…æ™°çš„èŒè´£åˆ†ç¦»
- **ConfigurationLoader**ï¼šåªè´Ÿè´£åŠ è½½åŸå§‹é…ç½®
- **ConfigurationManager**ï¼šåªè´Ÿè´£ç¼“å­˜å’Œç®¡ç†
- **MonsterConfig**ï¼šåªè´Ÿè´£æ•°æ®è§£æå’Œè½¬æ¢
- **MonsterService**ï¼šåªè´Ÿè´£ä¸šåŠ¡é€»è¾‘

### 2. é«˜æ‰©å±•æ€§
- SPI æ¥å£è®¾è®¡ï¼Œå¯è½»æ¾æ·»åŠ æ–°çš„åŠ è½½æ–¹å¼
- é…ç½®è§£æé€»è¾‘åœ¨æ¨¡å‹å±‚ï¼Œç‹¬ç«‹äºåŠ è½½é€»è¾‘
- æœåŠ¡å±‚å¯ä»¥å¼•ç”¨å…¶ä»–æœåŠ¡ï¼Œæ”¯æŒå¤æ‚ä¸šåŠ¡

### 3. é«˜æ€§èƒ½
- é…ç½®ç¼“å­˜æœºåˆ¶
- Map ç»“æ„æä¾› O(1) æŸ¥æ‰¾æ•ˆç‡
- é¿å…é‡å¤æ–‡ä»¶ I/O

### 4. æ˜“ç»´æŠ¤
- åŒ…ç»“æ„æ¸…æ™°
- å„ç»„ä»¶èŒè´£æ˜ç¡®
- ä»£ç å¤ç”¨æ€§é«˜

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åœ¨ä¸»ç±»ä¸­åˆå§‹åŒ–

```java
public class MonsterController extends JavaPlugin {
    private ConfigurationManager configManager;
    private MonsterService monsterService;
    
    @Override
    public void onEnable() {
        // åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨
        FileConfigurationLoader loader = new FileConfigurationLoader(this);
        configManager = new ConfigurationManager(loader);
        
        // åŠ è½½ä¸»é…ç½®
        YamlConfiguration config = configManager.getConfig("config.yml");
        String message = config.getString("messages.onEnable");
        getLogger().info(message);
        
        // åˆå§‹åŒ–æ€ªç‰©æœåŠ¡
        monsterService = new MonsterService(configManager);
        monsterService.loadConfig();
        getLogger().info("åŠ è½½äº† " + monsterService.getMonsterCount() + " ä¸ªæ€ªç‰©é…ç½®");
    }
    
    public MonsterService getMonsterService() {
        return monsterService;
    }
}
```

### åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨

```java
// è·å–æœåŠ¡
MonsterService service = plugin.getMonsterService();

// æŸ¥è¯¢é…ç½®
MonsterConfig zombie = service.getMonsterConfig("ZOMBIE");
if (zombie != null) {
    int spawnRate = zombie.getSpawnRate();
    double dropMulti = zombie.getDropMulti();
    // ... ä½¿ç”¨é…ç½®
}

// éå†æ‰€æœ‰é…ç½®
for (MonsterConfig config : service.getAllMonsters()) {
    getLogger().info(config.getDesc());
}

// é‡è½½é…ç½®
service.reloadConfig();
```

## ğŸ“ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„é…ç½®åŠ è½½æ–¹å¼

1. å®ç° `ConfigurationLoader` æ¥å£ï¼š

```java
public class DatabaseConfigurationLoader implements ConfigurationLoader {
    @Override
    public YamlConfiguration loadConfig(String name) {
        // ä»æ•°æ®åº“åŠ è½½é…ç½®
    }
    
    @Override
    public YamlConfiguration reloadConfig(String name) {
        // é‡æ–°ä»æ•°æ®åº“åŠ è½½
    }
    
    @Override
    public boolean exists(String name) {
        // æ£€æŸ¥é…ç½®æ˜¯å¦å­˜åœ¨
    }
}
```

2. åœ¨ä¸»ç±»ä¸­ä½¿ç”¨ï¼š

```java
ConfigurationLoader loader = new DatabaseConfigurationLoader();
ConfigurationManager manager = new ConfigurationManager(loader);
```

### æ·»åŠ æ–°çš„ä¸šåŠ¡æ¨¡å‹

1. åœ¨ `model` åŒ…ä¸­åˆ›å»ºæ–°æ¨¡å‹ï¼š

```java
package com.cuzz.monsterController.model;

public class ItemConfig {
    // é“å…·é…ç½®å­—æ®µå’Œè§£æé€»è¾‘
}
```

2. åˆ›å»ºå¯¹åº”çš„æœåŠ¡ï¼š

```java
package com.cuzz.monsterController.service;

public class ItemService {
    private final ConfigurationManager configManager;
    // ä¸šåŠ¡é€»è¾‘
}
```

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **é…ç½®åŠ è½½å¤±è´¥**
   - æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨äº `resources` ç›®å½•
   - æ£€æŸ¥ YAML æ ¼å¼æ˜¯å¦æ­£ç¡®
   - æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯æ—¥å¿—

2. **è§£æè¿”å›ç©ºåˆ—è¡¨**
   - ç¡®è®¤é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®
   - æ£€æŸ¥ `monsters` é”®åæ˜¯å¦åŒ¹é…
   - éªŒè¯æ•°æ®ç±»å‹è½¬æ¢é€»è¾‘

3. **çƒ­é‡è½½ä¸ç”Ÿæ•ˆ**
   - ç¡®è®¤è°ƒç”¨äº† `reloadConfig()` æ–¹æ³•
   - æ£€æŸ¥ç¼“å­˜æ˜¯å¦æ­£ç¡®æ›´æ–°
   - éªŒè¯æœåŠ¡æ˜¯å¦é‡æ–°åŠ è½½äº†é…ç½®

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

- âœ… é…ç½®ç¼“å­˜é¿å…é‡å¤ I/O
- âœ… Map ç»“æ„æä¾› O(1) æŸ¥æ‰¾
- âœ… å»¶è¿ŸåŠ è½½é…ç½®æ–‡ä»¶
- âœ… é¿å…ä¸å¿…è¦çš„é…ç½®é‡è½½

## ğŸ“ æœ€ä½³å®è·µ

1. **é…ç½®æ–‡ä»¶åˆ†ç¦»**ï¼šå°†ä¸åŒç±»å‹çš„é…ç½®åˆ†åˆ°ä¸åŒæ–‡ä»¶
2. **ä½¿ç”¨æœåŠ¡å±‚**ï¼šä¸šåŠ¡é€»è¾‘é€šè¿‡ Service è®¿é—®é…ç½®
3. **ç¼“å­˜ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨ Service çš„ç¼“å­˜ï¼Œé¿å…é¢‘ç¹è®¿é—® Manager
4. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨å¼ºç±»å‹æ¨¡å‹è€Œä¸æ˜¯ç›´æ¥æ“ä½œ YAML
5. **é”™è¯¯å¤„ç†**ï¼šé€‚å½“å¤„ç†é…ç½®ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯çš„æƒ…å†µ